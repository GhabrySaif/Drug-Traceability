import json
from web3 import Web3
# import board
# import adafruit_dht
import time

web3 = Web3(Web3.HTTPProvider('http://127.0.0.1:8545/'))

abi = json.loads('[     {       "inputs": [],       "stateMutability": "nonpayable",       "type": "constructor"     },     {       "inputs": [],       "name": "Admin",       "outputs": [         {           "internalType": "address",           "name": "",           "type": "address"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "Fabricantlist",       "outputs": [         {           "internalType": "address[]",           "name": "",           "type": "address[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "uint32[]",           "name": "",           "type": "uint32[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "medicamentListforFabricant1",       "outputs": [         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "uint32[]",           "name": "",           "type": "uint32[]"         },         {           "internalType": "uint32[]",           "name": "",           "type": "uint32[]"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "medicamentListforFabricant2",       "outputs": [         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "uint32[]",           "name": "",           "type": "uint32[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "medicamentListforpharmacien1",       "outputs": [         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "uint32[]",           "name": "",           "type": "uint32[]"         },         {           "internalType": "uint32[]",           "name": "",           "type": "uint32[]"         },         {           "internalType": "uint32[]",           "name": "",           "type": "uint32[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "medicamentListforpharmacien2",       "outputs": [         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "medicamentListfortransporteur1",       "outputs": [         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "uint32[]",           "name": "",           "type": "uint32[]"         },         {           "internalType": "uint32[]",           "name": "",           "type": "uint32[]"         },         {           "internalType": "uint32[]",           "name": "",           "type": "uint32[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "medicamentListfortransporteur2",       "outputs": [         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "pharmacienlist",       "outputs": [         {           "internalType": "address[]",           "name": "",           "type": "address[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "uint32[]",           "name": "",           "type": "uint32[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "transporteurlist",       "outputs": [         {           "internalType": "address[]",           "name": "",           "type": "address[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "uint32[]",           "name": "",           "type": "uint32[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         },         {           "internalType": "string[]",           "name": "",           "type": "string[]"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [         {           "internalType": "address",           "name": "_id",           "type": "address"         },         {           "internalType": "string",           "name": "_name",           "type": "string"         },         {           "internalType": "uint32",           "name": "_phonenumber",           "type": "uint32"         },         {           "internalType": "string",           "name": "_gouvernorat",           "type": "string"         }       ],       "name": "signupFabricant",       "outputs": [],       "stateMutability": "nonpayable",       "type": "function"     },     {       "inputs": [         {           "internalType": "address",           "name": "_id",           "type": "address"         },         {           "internalType": "string",           "name": "_name",           "type": "string"         },         {           "internalType": "uint32",           "name": "_phonenumber",           "type": "uint32"         },         {           "internalType": "string",           "name": "_gouvernorat",           "type": "string"         }       ],       "name": "signupTransporteur",       "outputs": [],       "stateMutability": "nonpayable",       "type": "function"     },     {       "inputs": [         {           "internalType": "address",           "name": "_id",           "type": "address"         },         {           "internalType": "string",           "name": "_name",           "type": "string"         },         {           "internalType": "uint32",           "name": "_phonenumber",           "type": "uint32"         },         {           "internalType": "string",           "name": "_gouvernorat",           "type": "string"         }       ],       "name": "signupPharmacien",       "outputs": [],       "stateMutability": "nonpayable",       "type": "function"     },     {       "inputs": [         {           "internalType": "address",           "name": "_id",           "type": "address"         },         {           "internalType": "string",           "name": "_statut",           "type": "string"         }       ],       "name": "block_deblockFabricant",       "outputs": [],       "stateMutability": "nonpayable",       "type": "function"     },     {       "inputs": [         {           "internalType": "address",           "name": "_id",           "type": "address"         },         {           "internalType": "string",           "name": "_statut",           "type": "string"         }       ],       "name": "block_deblockTransporteur",       "outputs": [],       "stateMutability": "nonpayable",       "type": "function"     },     {       "inputs": [         {           "internalType": "address",           "name": "_id",           "type": "address"         },         {           "internalType": "string",           "name": "_statut",           "type": "string"         }       ],       "name": "block_deblockPharmacien",       "outputs": [],       "stateMutability": "nonpayable",       "type": "function"     },     {       "inputs": [],       "name": "isAdminExists",       "outputs": [         {           "internalType": "string",           "name": "",           "type": "string"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "isFabricantExists",       "outputs": [         {           "internalType": "string",           "name": "",           "type": "string"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "isTransporteurExists",       "outputs": [         {           "internalType": "string",           "name": "",           "type": "string"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "isPharmacienExists",       "outputs": [         {           "internalType": "string",           "name": "",           "type": "string"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "AdministrateurName",       "outputs": [         {           "internalType": "string",           "name": "",           "type": "string"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "FabricantName",       "outputs": [         {           "internalType": "string",           "name": "",           "type": "string"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "TransporteurName",       "outputs": [         {           "internalType": "string",           "name": "",           "type": "string"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [],       "name": "PharmacienName",       "outputs": [         {           "internalType": "string",           "name": "",           "type": "string"         }       ],       "stateMutability": "view",       "type": "function",       "constant": true     },     {       "inputs": [         {           "internalType": "string",           "name": "_nommedicament",           "type": "string"         },         {           "internalType": "string",           "name": "_Datef",           "type": "string"         },         {           "internalType": "uint32",           "name": "_Tempmax",           "type": "uint32"         },         {           "internalType": "uint32",           "name": "_Tempmin",           "type": "uint32"         }       ],       "name": "setMedicament",       "outputs": [],       "stateMutability": "nonpayable",       "type": "function"     },     {       "inputs": [         {           "internalType": "string",           "name": "_nommedicament",           "type": "string"         },         {           "internalType": "uint32",           "name": "_Quantite",           "type": "uint32"         },         {           "internalType": "string",           "name": "_Dated",           "type": "string"         },         {           "internalType": "address",           "name": "_idtransporteur",           "type": "address"         },         {           "internalType": "address",           "name": "idpharmacien",           "type": "address"         }       ],       "name": "setRequest",       "outputs": [],       "stateMutability": "nonpayable",       "type": "function"     },     {       "inputs": [         {           "internalType": "string",           "name": "_nommedicament",           "type": "string"         },         {           "internalType": "string",           "name": "_condition",           "type": "string"         }       ],       "name": "setCondtion",       "outputs": [],       "stateMutability": "nonpayable",       "type": "function"     },     {       "inputs": [         {           "internalType": "string",           "name": "_nommedicament",           "type": "string"         },         {           "internalType": "string",           "name": "_demande",           "type": "string"         }       ],       "name": "setEtatdelademande",       "outputs": [],       "stateMutability": "nonpayable",       "type": "function"     },     {       "inputs": [         {           "internalType": "string",           "name": "_nommedicament",           "type": "string"         },         {           "internalType": "string",           "name": "_commande",           "type": "string"         }       ],       "name": "setEtatdelacommande",       "outputs": [],       "stateMutability": "nonpayable",       "type": "function"     }   ]')

address = '0x005Dcd67A0Ab8b0BE86eD24938883D660c34df31'

contract = web3.eth.contract(address=address, abi=abi)

# dhtDevice = adafruit_dht.DHT11(board.D18, use_pulseio=False)

while True:
    
    # temperature = dhtDevice.temperature
    temperature = 31
    print("Temperature actuelle : ",temperature,"°C")
    
    tab = contract.functions.medicamentListfortransporteur1().call(
        {'from': '0xa521a269092a7f1031d111fC2e640cb2231dA29f'})
    
    tab1 = contract.functions.medicamentListfortransporteur2().call(
        {'from': '0xa521a269092a7f1031d111fC2e640cb2231dA29f'})
    
    for i in range(len(tab[0])):
        temMin = tab[3][i]
        temMax = tab[4][i]
        condition = tab[5][i]
        etatdelademande = tab1[0][i]
        etatdelacommande = tab1[1][i]
        if (((temMin > temperature) or (temMax) < temperature) and (condition != "température dépassée")
            and (etatdelademande == "Acceptée") and (etatdelacommande != "Livré")):
            contract.functions.setCondtion(
                tab[0][i], "température dépassée").transact({'from': '0xa521a269092a7f1031d111fC2e640cb2231dA29f'})
            print(tab[0], " : ", "température dépassée")
        else : continue
    time.sleep(10.0)
